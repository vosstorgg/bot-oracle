# üîÑ Webhook –≤–µ—Ä—Å–∏—è Dream Analysis Bot

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø–µ—Ä–µ—Ö–æ–¥—É —Å polling –Ω–∞ webhook –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
bot-oracle/
‚îú‚îÄ‚îÄ bot.py              # –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è polling –≤–µ—Ä—Å–∏—è (–ù–ï –¢–†–û–ì–ê–¢–¨ –≤ production)
‚îú‚îÄ‚îÄ app.py              # –ù–æ–≤–∞—è webhook –≤–µ—Ä—Å–∏—è
‚îú‚îÄ‚îÄ bot_handlers.py     # –û–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±–µ–∏—Ö –≤–µ—Ä—Å–∏–π
‚îú‚îÄ‚îÄ webhook_config.py   # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è webhook
‚îú‚îÄ‚îÄ requirements.txt    # –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ Procfile           # –î–ª—è polling –≤–µ—Ä—Å–∏–∏ (production)
‚îú‚îÄ‚îÄ Procfile.webhook   # –î–ª—è webhook –≤–µ—Ä—Å–∏–∏ (—Ç–µ—Å—Ç—ã)
‚îî‚îÄ‚îÄ README_WEBHOOK.md  # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Railway

### 1. –¢–µ—Å—Ç–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (–≤–µ—Ç–∫–∞ main)

1. **–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –Ω–∞ Railway** –¥–ª—è —Ç–µ—Å—Ç–æ–≤
2. **–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –≤–µ—Ç–∫—É `main`** —ç—Ç–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
3. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   ```
   TELEGRAM_TOKEN=your_test_bot_token
   WEBHOOK_URL=https://your-test-app.railway.app
   SECRET_TOKEN=any_random_32_char_string
   OPENAI_API_KEY=your_openai_key
   PGHOST=your_postgres_host
   PGPORT=5432
   PGUSER=your_postgres_user
   PGPASSWORD=your_postgres_password
   PGDATABASE=your_postgres_db
   ```

4. **–ü–µ—Ä–µ–∏–º–µ–Ω—É–π—Ç–µ Procfile:**
   ```bash
   mv Procfile Procfile.polling
   mv Procfile.webhook Procfile
   ```

### 2. –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –Ω–∞ Railway

–í—Å–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è —Å—Ä–∞–∑—É –Ω–∞ Railway –±–µ–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

## üîß API Endpoints

### –û—Å–Ω–æ–≤–Ω—ã–µ endpoints:

- `GET /` - –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
- `GET /health` - Health check –¥–ª—è Railway
- `POST /webhook` - –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram
- `GET /webhook_info` - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º webhook

### –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ endpoints:

- `POST /set_webhook` - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook
- `DELETE /webhook` - –£–¥–∞–ª–µ–Ω–∏–µ webhook

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

Webhook –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç Telegram:
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `SECRET_TOKEN`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-Telegram-Bot-Api-Secret-Token`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏
–í—Å–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –º–µ—Ç–∫–∞–º–∏:
- `üì®` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- `‚úÖ` - –£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏  
- `‚ùå` - –û—à–∏–±–∫–∏
- `‚ö†Ô∏è` - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

### Health Check
```bash
curl https://your-app.railway.app/health
```

### Webhook Status
```bash
curl https://your-app.railway.app/webhook_info
```

## üîÑ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ production

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏** –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ
2. **–£–±–µ–¥–∏—Ç–µ—Å—å –≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏** webhook –≤–µ—Ä—Å–∏–∏
3. **–í production –≤–µ—Ç–∫–µ:**
   - –ó–∞–º–µ–Ω–∏—Ç–µ `bot.py` –Ω–∞ `app.py`
   - –û–±–Ω–æ–≤–∏—Ç–µ `Procfile`
   - –û–±–Ω–æ–≤–∏—Ç–µ `requirements.txt`
4. **–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ webhook** –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞

## üö® Rollback –ø–ª–∞–Ω

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫:
1. –û—Ç–∫–∞—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ production –≤–µ—Ç–∫–µ
2. –£–¥–∞–ª–∏—Ç–µ webhook: `curl -X DELETE https://your-app.railway.app/webhook`
3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ polling –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º `bot.py`

## üîß Troubleshooting –Ω–∞ Railway

### Webhook –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ Railway logs –∏–ª–∏ `/webhook_info`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ WEBHOOK_URL —É–∫–∞–∑–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SECRET_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### Railway –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: Railway dashboard ‚Üí Deployments ‚Üí Logs
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ health check: `https://your-app.railway.app/health`

### –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL –≤ –ª–æ–≥–∞—Ö
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ OpenAI API –∫–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook —Å—Ç–∞—Ç—É—Å: `https://your-app.railway.app/webhook_info`

## üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ webhook

- ‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (vs 1-2 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∞ polling)
- üí∞ –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ (–Ω–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤)
- üîí –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (—Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω)
- üìà –õ—É—á—à–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
